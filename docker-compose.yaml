services:
  # 1. PostgreSQL DB
  db:
    image: postgres:15
    container_name: oriana-db
    ports:
      - "5432:5432"
    environment:
      POSTGRES_DB: ${DB_NAME}      # .env의 DB_NAME 사용
      POSTGRES_USER: ${DB_USER}    # .env의 DB_USER 사용
      POSTGRES_PASSWORD: ${DB_PASSWORD} # .env의 DB_PASSWORD 사용
    volumes:
      - db_data:/var/lib/postgresql/data # 아래 정의된 볼륨 사용 (권한 문제 해결)
    networks:
      - oriana-net  # ★ DB도 이 네트워크에 꼭 넣어줘야 백엔드랑 대화 가능!
    restart: always

  # 2. 백엔드 (Spring Boot)
  backend:
    build: ./backend
    container_name: oriana-backend
    ports:
      - "8080:8080"
    environment:
      # ★ 중요: 백엔드도 .env에 적힌 이름(DB_USER) 그대로 가져와야 함!
      SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/oriana_db
      SPRING_DATASOURCE_USERNAME: ${DB_USER}     # 고침 (POSTGRES_USER -> DB_USER)
      SPRING_DATASOURCE_PASSWORD: ${DB_PASSWORD} # 고침 (POSTGRES_PASSWORD -> DB_PASSWORD)
      GEMINI_API_KEY: ${GEMINI_API_KEY}
    depends_on:
      - db
    networks:
      - oriana-net

  # 3. 프론트엔드 (Vue + Nginx)
  frontend:
    build: ./frontend
    container_name: oriana-frontend
    ports:
      - "80:80"
    depends_on:
      - backend
    networks:
      - oriana-net

# 4. (옵션) pgAdmin - 필요 없으면 주석 처리해도 됨
  pgadmin:
    image: dpage/pgadmin4
    container_name: hackathon-pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL}
      PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
    ports:
      - "5050:80"
    depends_on:
      - db
    networks:
      - oriana-net # 얘도 같은 망에 있어야 DB 접속 가능

volumes:
  db_data:

networks:
  oriana-net:
    driver: bridge